
# HG changeset patch
# User John M. Schanck <jschanck@mozilla.com>
# Date 1652293380 0
# Node ID 927d47dcc509bd4f561c5a6e6e7b050b63f03009
# Parent  83a89ed9f52783e73ad63b88780faa85b381fe89
Bug 1454072 - Use of uninitialized pointer in lg_init after alloc fail. r=nss-reviewers,nkulatova

Differential Revision: https://phabricator.services.mozilla.com/D142715

diff --git a/nss/lib/softoken/legacydb/lginit.c b/nss/lib/softoken/legacydb/lginit.c
--- a/nss/lib/softoken/legacydb/lginit.c
+++ b/nss/lib/softoken/legacydb/lginit.c
@@ -510,16 +510,17 @@ lg_init(SDB **pSdb, int flags, NSSLOWCER
     lgdb_p->keyDB = keydbPtr;
     lgdb_p->dbLock = PR_NewLock();
     if (lgdb_p->dbLock == NULL) {
         goto loser;
     }
     lgdb_p->hashTable = PL_NewHashTable(64, lg_HashNumber, PL_CompareValues,
                                         SECITEM_HashCompare, NULL, 0);
     if (lgdb_p->hashTable == NULL) {
+        PR_DestroyLock(lgdb_p->dbLock);
         goto loser;
     }
 
     sdb->private = lgdb_p;
     sdb->version = 1;
     sdb->sdb_flags = flags;
     sdb->app_private = NULL;
     sdb->sdb_FindObjectsInit = lg_FindObjectsInit;
@@ -543,22 +544,16 @@ lg_init(SDB **pSdb, int flags, NSSLOWCER
     *pSdb = sdb;
     return CKR_OK;
 
 loser:
     if (sdb) {
         PORT_Free(sdb);
     }
     if (lgdb_p) {
-        if (lgdb_p->dbLock) {
-            PR_DestroyLock(lgdb_p->dbLock);
-        }
-        if (lgdb_p->hashTable) {
-            PL_HashTableDestroy(lgdb_p->hashTable);
-        }
         PORT_Free(lgdb_p);
     }
     return error;
 }
 
 /*
  * OK there are now lots of options here, lets go through them all:
  *

